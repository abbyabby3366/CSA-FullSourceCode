<!DOCTYPE html>
<html lang="en" data-layout="vertical" data-topbar="light" data-sidebar="dark" data-sidebar-size="lg" data-sidebar-image="none" data-preloader="disable">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Submitted Surveys | Admin Portal</title>

    <script src="../assets/js/layout.js"></script>

    <!-- bootstrap css -->
    <link rel="stylesheet" href="../assets/css/bootstrap.css">

    <!-- font css -->
	<link rel="stylesheet" href="../assets/css/icons.min.css">

    <!-- app css -->
	<link rel="stylesheet" href="../assets/css/app.min.css" />

    <!-- custom css -->
	<link rel="stylesheet" href="../assets/css/custom.css">

    <link href="../assets/images/logos/favicon.ico" rel="shortcut icon" type="image/x-icon" />
</head>
<body>
    <div class="layout-wrapper">
        <!-- page header -->
        <header id="page-topbar"></header>					
        
        <div class="app-menu navbar-menu"></div>
        
        <div class="vertical-overlay"></div>

        <div class="main-content">
            <div class="page-content">
                <div class="container-fluid">
                    <div class="row mb-3 pb-1">
                        <div class="col-12">
                            <div class="d-flex align-items-lg-center flex-lg-row flex-column">
                                <div class="flex-grow-1">
                                    <h4 class="fs-16 mb-1">Submitted Surveys</h4>
                                    <p class="text-muted mb-0">Review responses from YABAM participants.</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-lg-12">
                            <div class="card">
                                <div class="card-body">
                                    <div class="table-responsive table-card">
                                        <table class="table table-borderless table-nowrap align-middle mb-0">
                                            <thead class="table-light text-muted">
                                                <tr class="text-uppercase fs-11 fw-bold text-center">
                                                    <th colspan="2" class="border-end bg-light-subtle">Member Details</th>
                                                    <th colspan="3" class="border-end">Survey Responses</th>
                                                    <th colspan="3">System Info</th>
                                                </tr>
                                                <tr>
                                                    <th>Name & Code</th>
                                                    <th>Phone</th>
                                                    <th>State</th>
                                                    <th>Current Job</th>
                                                    <th>Guru</th>
                                                    <th>Submitted</th>
                                                    <th>Status</th>
                                                    <th class="text-center">Action</th>
                                                </tr>
                                            </thead>
                                            <tbody id="surveyTableBody">
                                                <tr>
                                                    <td colspan="8" class="text-center p-5">
                                                        <div class="spinner-border text-primary" role="status">
                                                            <span class="visually-hidden">Loading...</span>
                                                        </div>
                                                        <p class="mt-2 text-muted">Fetching survey data...</p>
                                                    </td>
                                                </tr>
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <footer class="footer">
                <div class="container-fluid">
                    <div class="row">
                        <div class="col-sm-6">
                            Copyright <script>document.write(new Date().getFullYear())</script> Â© CSA Academy - All right reserved.
                        </div>
                    </div>
                </div>
            </footer>
        </div>
    </div>

    <!-- Survey Details Modal -->
    <div class="modal fade" id="surveyDetailsModal" tabindex="-1" aria-labelledby="surveyDetailsModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg modal-dialog-scrollable">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="surveyDetailsModalLabel">Survey Response Details</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body" id="surveyModalBody">
                    <!-- Dynamic Content -->
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="button" class="btn btn-primary" onclick="window.print()">Print Response</button>
                </div>
            </div>
        </div>
    </div>

    <!-- jquery js -->
    <script src="../assets/libs/jquery/js/jquery-3.6.3.min.js"></script>
    <!-- bootstrap js -->
    <script src="../assets/libs/bootstrap/js/bootstrap.bundle.min.js"></script>
    <script src="../assets/libs/simplebar/simplebar.min.js"></script>
    <script src="../assets/libs/node-waves/waves.min.js"></script>
    <script src="../assets/libs/feather-icons/feather.min.js"></script>
    <!-- App js -->
    <script src="../assets/js/app.js"></script>
    <script src="../Scripts/navbar.js"></script>
    <script src="../Scripts/adminHelper.js"></script>

    <script>
        let allSurveys = [];

        $(document).ready(async function() {
            const surveys = await apiCall('/surveys/admin/all');
            const tbody = $('#surveyTableBody');
            
            if (surveys && surveys.length > 0) {
                allSurveys = surveys;
                tbody.empty();
                surveys.forEach((s, index) => {
                    try {
                        const memberName = s.member ? `${s.member.firstName} ${s.member.lastName} (${s.member.memberCode})` : 'N/A';
                        const phoneNumber = s.member ? s.member.phoneNumber : 'N/A';
                        const submittedAt = s.submittedAt ? new Date(s.submittedAt).toLocaleString() : 'N/A';
                        
                        let statusBadge = '';
                        if (s.status === 'Pending') statusBadge = '<span class="badge bg-warning-subtle text-warning">Pending</span>';
                        else if (s.status === 'Verified') statusBadge = '<span class="badge bg-success-subtle text-success">Verified</span>';
                        else if (s.status === 'Rejected') statusBadge = '<span class="badge bg-danger-subtle text-danger">Rejected</span>';
                        else statusBadge = `<span class="badge bg-info-subtle text-info">${s.status || 'N/A'}</span>`;

                        let actionButtons = '';
                        if (s.status === 'Pending' || s.status === 'Completed') {
                            actionButtons += `
                                <button class="btn btn-sm btn-soft-success approve-survey-btn" data-id="${s._id}">
                                    <i class="ri-check-line align-bottom"></i> Approve
                                </button>
                                <button class="btn btn-sm btn-soft-danger reject-survey-btn" data-id="${s._id}">
                                    <i class="ri-close-line align-bottom"></i> Reject
                                </button>
                            `;
                        }

                        actionButtons += `
                            <button class="btn btn-sm btn-soft-primary view-survey-btn" data-index="${index}">
                                <i class="ri-eye-line align-bottom"></i> View
                            </button>
                        `;

                        tbody.append(`
                            <tr id="survey-${s._id}">
                                <td class="bg-light-subtle border-end">${memberName}</td>
                                <td class="bg-light-subtle border-end">${phoneNumber}</td>
                                <td>${s.section1?.state || 'N/A'}</td>
                                <td>${s.section1?.jobPositionCategory || ''} - ${s.section1?.jobPositionLevel || ''}</td>
                                <td>${s.finalSection?.favoriteGuru || 'N/A'}</td>
                                <td>${submittedAt}</td>
                                <td>${statusBadge}</td>
                                <td class="text-center">
                                    <div class="d-flex justify-content-center gap-2">
                                        ${actionButtons}
                                        <button class="btn btn-sm btn-soft-danger delete-survey-btn" data-id="${s._id}">
                                            <i class="ri-delete-bin-fill align-bottom"></i>
                                        </button>
                                    </div>
                                </td>
                            </tr>
                        `);
                    } catch (e) {
                        console.error('Error rendering survey row:', e, s);
                    }
                });
            } else {
                tbody.html('<tr><td colspan="8" class="text-center">No surveys found.</td></tr>');
            }

            // Handle Approve
            $(document).on('click', '.approve-survey-btn', async function() {
                const surveyId = $(this).data('id');
                if (confirm('Are you sure you want to APPROVE this survey? This will credit RM100 to the user and their referrer.')) {
                    try {
                        const result = await apiCall('/surveys/admin/approve/' + surveyId, 'POST');
                        if (result && result.survey) {
                            location.reload(); // Quick refresh to update status and hide buttons
                        } else {
                            alert(result.msg || 'Error approving survey');
                        }
                    } catch (err) {
                        console.error('Approve error:', err);
                        alert('Failed to approve survey.');
                    }
                }
            });

            // Handle Reject
            $(document).on('click', '.reject-survey-btn', async function() {
                const surveyId = $(this).data('id');
                if (confirm('Are you sure you want to REJECT this survey?')) {
                    try {
                        const result = await apiCall('/surveys/admin/reject/' + surveyId, 'POST');
                        if (result && result.survey) {
                            location.reload();
                        } else {
                            alert(result.msg || 'Error rejecting survey');
                        }
                    } catch (err) {
                        console.error('Reject error:', err);
                        alert('Failed to reject survey.');
                    }
                }
            });

            // Handle Delete
            $(document).on('click', '.delete-survey-btn', async function() {
                const surveyId = $(this).data('id');
                if (confirm('Are you sure you want to delete this survey? This action cannot be undone.')) {
                    try {
                        const result = await apiCall('/surveys/' + surveyId, 'DELETE');
                        if (result && result.msg === 'Survey removed') {
                            $(`#survey-${surveyId}`).fadeOut(function() {
                                $(this).remove();
                                if ($('#surveyTableBody tr').length === 0) {
                                    $('#surveyTableBody').html('<tr><td colspan="8" class="text-center">No surveys found.</td></tr>');
                                }
                            });
                        } else {
                            alert(result.msg || 'Error deleting survey');
                        }
                    } catch (err) {
                        console.error('Delete error:', err);
                        alert('Failed to delete survey. Please try again.');
                    }
                }
            });

            $(document).on('click', '.view-survey-btn', function() {
                const index = $(this).data('index');
                const s = allSurveys[index];
                if (!s) return;

                const memberName = s.member ? `${s.member.firstName} ${s.member.lastName}` : 'N/A';
                const submittedAt = s.submittedAt ? new Date(s.submittedAt).toLocaleString() : 'N/A';
                
                let html = `
                    <div class="row">
                        <!-- Section 1: Actual Member Details (from registration) -->
                        <div class="col-12 p-3 bg-light-subtle border rounded mb-3">
                            <h6 class="text-uppercase fw-bold text-muted mb-3"><i class="ri-user-heart-line align-bottom me-1"></i> Actual Member Details</h6>
                            <div class="row">
                                <div class="col-md-6 mb-2"><strong>Full Name:</strong><br>${memberName}</div>
                                <div class="col-md-6 mb-2"><strong>Member Code:</strong><br>${s.member?.memberCode || 'N/A'}</div>
                                <div class="col-md-6 mb-2"><strong>Phone Number:</strong><br>${s.member?.phoneNumber || 'N/A'}</div>
                                <div class="col-md-6 mb-2"><strong>Email Address:</strong><br>${s.member?.email || 'N/A'}</div>
                            </div>
                        </div>

                        <!-- Section 2: Survey Responses -->
                        <div class="col-12 p-3 border rounded mb-3">
                            <h6 class="text-uppercase fw-bold text-primary mb-3"><i class="ri-survey-line align-bottom me-1"></i> Survey Responses</h6>
                            
                            <h6 class="mt-3 fs-13 text-muted border-bottom pb-1">Bahagian A: Maklumat Pekerjaan</h6>
                            <div class="row mt-2">
                                <div class="col-md-6 mb-2"><strong>Negeri:</strong> ${s.section1?.state || 'N/A'}</div>
                                <div class="col-md-6 mb-2"><strong>Kategori Jawatan:</strong> ${s.section1?.jobPositionCategory || 'N/A'}</div>
                                <div class="col-md-6 mb-2"><strong>Tahap Jawatan:</strong> ${s.section1?.jobPositionLevel || 'N/A'}</div>
                                <div class="col-md-12 mb-2"><strong>Nama Majikan:</strong> ${s.section1?.employerName || 'N/A'}</div>
                            </div>

                            <h6 class="mt-4 fs-13 text-muted border-bottom pb-1">Bahagian B: Maklumat Kewangan</h6>
                            <div class="row mt-2">
                                <div class="col-md-6 mb-2"><strong>Pendapatan Keluarga:</strong> ${s.section2?.familyIncome || 'N/A'}</div>
                                <div class="col-md-6 mb-2"><strong>Julat Hutang:</strong> ${s.section2?.debtRange || 'N/A'}</div>
                            </div>

                            <h6 class="mt-4 fs-13 text-muted border-bottom pb-1">Bahagian C: Maklum Balas</h6>
                            <div class="row mt-2">
                                <div class="col-md-12 mb-2"><strong>Guru Kewangan Diminati:</strong> ${s.finalSection?.favoriteGuru || 'N/A'}</div>
                            </div>

                            <h6 class="mt-4 fs-13 text-muted border-bottom pb-1">Maklumat Pembayaran (Tujuan Insentif)</h6>
                            <div class="row mt-2 text-success">
                                <div class="col-md-6 mb-2"><strong>Nama Bank:</strong> ${s.bankDetails?.bankName || 'N/A'}</div>
                                <div class="col-md-6 mb-2"><strong>Nombor Akaun:</strong> ${s.bankDetails?.bankAccountNumber || 'N/A'}</div>
                            </div>
                        </div>

                        <!-- System Status -->
                        <div class="col-12 text-end">
                            <span class="badge bg-light text-muted p-2">Submitted on ${submittedAt}</span>
                        </div>
                    </div>
                `;

                $('#surveyModalBody').html(html);
                $('#surveyDetailsModal').modal('show');
            });
        });
    </script>
</body>
</html>
