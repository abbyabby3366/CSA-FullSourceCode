<!DOCTYPE html>
<html lang="en" data-layout="vertical" data-topbar="light" data-sidebar="dark" data-sidebar-size="lg" data-sidebar-image="none" data-preloader="disable">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Submitted Surveys | Admin Portal</title>

    <script src="assets/js/layout.js"></script>

    <!-- bootstrap css -->
    <link rel="stylesheet" href="assets/css/bootstrap.css">

    <!-- font css -->
	<link rel="stylesheet" href="assets/css/icons.min.css">

    <!-- app css -->
	<link rel="stylesheet" href="assets/css/app.min.css" />

    <!-- custom css -->
	<link rel="stylesheet" href="assets/css/custom.css">

    <link href="assets/images/logos/favicon.ico" rel="shortcut icon" type="image/x-icon" />
</head>
<body>
    <div class="layout-wrapper">
        <!-- page header -->
        <header id="page-topbar">
            <div class="layout-width">
                <div class="navbar-header">
                    <div class="d-flex">
                        <!-- logo -->
                        <div class="navbar-brand-box horizontal-logo">
                            <a href="dashboard.html" class="logo logo-dark">
                                <span class="logo-sm">
                                    <img src="assets/images/logos/logo-main.png" alt="" height="22">
                                </span>
                                <span class="logo-lg">
                                    <img src="assets/images/logos/logo-dark.png" alt="" height="37">
                                </span>
                            </a>
                        </div>

                        <button type="button" class="btn btn-sm px-3 fs-16 header-item vertical-menu-btn topnav-hamburger" id="topnav-hamburger-icon">
                            <span class="hamburger-icon">
                                <span></span>
                                <span></span>
                                <span></span>
                            </span>
                        </button>
                    </div>

                    <div class="d-flex align-items-center">
                        <div class="dropdown ms-sm-1 header-item topbar-user">
                            <button type="button" class="btn" id="page-header-user-dropdown" data-bs-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                                <span class="d-flex align-items-center">
                                    <img class="rounded-circle header-profile-user" src="assets/images/users/avatar-1.jpg" alt="Header Avatar">
                                    <span class="text-start ms-xl-2">
                                        <span class="d-none d-xl-inline-block ms-1 fw-medium user-name-text">Admin User</span>
                                        <span class="d-none d-xl-block ms-1 fs-12 user-name-sub-text">Super Admin</span>
                                    </span>
                                </span>
                            </button>

                            <div class="dropdown-menu dropdown-menu-end">
                                <h6 class="dropdown-header">Welcome Admin!</h6>
                                <a class="dropdown-item" href="profile.html"><i class="mdi mdi-account-circle text-muted fs-16 align-middle me-1"></i> <span class="align-middle">Profile</span></a>
                                <div class="dropdown-divider"></div>
                                <a class="dropdown-item" href="index.html"><i class="mdi mdi-logout text-muted fs-16 align-middle me-1"></i> <span class="align-middle">Logout</span></a>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </header>					
        
        <div class="app-menu navbar-menu">
            <!-- logo -->
            <div class="navbar-brand-box">
                <a href="dashboard.html" class="logo logo-dark">
                    <span class="logo-sm">
                        <img src="assets/images/logos/logo-main.png" alt="" height="22">
                    </span>
                    <span class="logo-lg">
                        <img src="assets/images/logos/logo-light.png" alt="" height="37">
                    </span>
                </a>

                <button type="button" class="btn btn-sm p-0 fs-20 header-item float-end btn-vertical-sm-hover" id="vertical-hover">
                    <i class="ri-record-circle-line"></i>
                </button>
            </div>

            <div id="scrollbar">
                <div class="container-fluid">
                    <ul class="navbar-nav" id="navbar-nav">
                        <li class="menu-title"><span data-key="t-main">Main</span></li>
                        <li class="nav-item">
                            <a class="nav-link menu-link" href="dashboard.html">
                                <i class="ri-home-8-line"></i> <span data-key="t-dashboard"> Dashboards </span>
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link menu-link active" href="surveys.html">
                                <i class="ri-survey-line"></i> <span data-key="t-surveys"> Submitted Surveys </span>
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link menu-link" href="applications.html">
                                <i class="mdi mdi-application-cog-outline"></i> <span data-key="t-application-manager"> Application Management </span>
                            </a>
                        </li>
                    </ul>
                </div>
            </div>
            <div class="sidebar-background"></div>
        </div>
        
        <div class="vertical-overlay"></div>

        <div class="main-content">
            <div class="page-content">
                <div class="container-fluid">
                    <div class="row mb-3 pb-1">
                        <div class="col-12">
                            <div class="d-flex align-items-lg-center flex-lg-row flex-column">
                                <div class="flex-grow-1">
                                    <h4 class="fs-16 mb-1">Submitted Surveys</h4>
                                    <p class="text-muted mb-0">Review responses from YABAM participants.</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-lg-12">
                            <div class="card">
                                <div class="card-body">
                                    <div class="table-responsive table-card">
                                        <table class="table table-borderless table-nowrap align-middle mb-0">
                                            <thead class="table-light text-muted">
                                                <tr>
                                                    <th>Member Name</th>
                                                    <th>Phone Number</th>
                                                    <th>State</th>
                                                    <th>Current Job</th>
                                                    <th>Favorite Guru</th>
                                                    <th>Submitted At</th>
                                                    <th>Status</th>
                                                    <th class="text-center">Action</th>
                                                </tr>
                                            </thead>
                                            <tbody id="surveyTableBody">
                                                <tr>
                                                    <td colspan="8" class="text-center p-5">
                                                        <div class="spinner-border text-primary" role="status">
                                                            <span class="visually-hidden">Loading...</span>
                                                        </div>
                                                        <p class="mt-2 text-muted">Fetching survey data...</p>
                                                    </td>
                                                </tr>
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <footer class="footer">
                <div class="container-fluid">
                    <div class="row">
                        <div class="col-sm-6">
                            Copyright <script>document.write(new Date().getFullYear())</script> Â© CSA Academy - All right reserved.
                        </div>
                    </div>
                </div>
            </footer>
        </div>
    </div>

    <!-- Survey Details Modal -->
    <div class="modal fade" id="surveyDetailsModal" tabindex="-1" aria-labelledby="surveyDetailsModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg modal-dialog-scrollable">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="surveyDetailsModalLabel">Survey Response Details</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body" id="surveyModalBody">
                    <!-- Dynamic Content -->
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="button" class="btn btn-primary" onclick="window.print()">Print Response</button>
                </div>
            </div>
        </div>
    </div>

    <!-- jquery js -->
    <script src="assets/libs/jquery/js/jquery-3.6.3.min.js"></script>
    <!-- bootstrap js -->
    <script src="assets/libs/bootstrap/js/bootstrap.bundle.min.js"></script>
    <script src="assets/libs/simplebar/simplebar.min.js"></script>
    <script src="assets/libs/node-waves/waves.min.js"></script>
    <script src="assets/libs/feather-icons/feather.min.js"></script>
    <script src="assets/js/app.js"></script>
    <script src="Scripts/adminHelper.js"></script>

    <script>
        let allSurveys = [];

        $(document).ready(async function() {
            const surveys = await apiCall('/surveys/admin/all');
            const tbody = $('#surveyTableBody');
            
            if (surveys && surveys.length > 0) {
                allSurveys = surveys;
                tbody.empty();
                surveys.forEach((s, index) => {
                    const memberName = s.member ? `${s.member.firstName} ${s.member.lastName}` : 'N/A';
                    const phoneNumber = s.member ? s.member.phoneNumber : 'N/A';
                    const submittedAt = new Date(s.submittedAt).toLocaleString();
                    
                    tbody.append(`
                        <tr>
                            <td>${memberName}</td>
                            <td>${phoneNumber}</td>
                            <td>${s.section1.state}</td>
                            <td>${s.section1.jobPositionCategory} - ${s.section1.jobPositionLevel}</td>
                            <td>${s.finalSection.favoriteGuru}</td>
                            <td>${submittedAt}</td>
                            <td><span class="badge bg-success-subtle text-success">${s.status}</span></td>
                            <td class="text-center">
                                <button class="btn btn-sm btn-soft-primary view-survey-btn" data-index="${index}">
                                    <i class="ri-eye-line align-bottom"></i> View
                                </button>
                            </td>
                        </tr>
                    `);
                });
            } else {
                tbody.html('<tr><td colspan="8" class="text-center">No surveys found.</td></tr>');
            }

            $(document).on('click', '.view-survey-btn', function() {
                const index = $(this).data('index');
                const s = allSurveys[index];
                if (!s) return;

                const memberName = s.member ? `${s.member.firstName} ${s.member.lastName}` : 'N/A';
                
                let html = `
                    <div class="row">
                        <div class="col-md-6 mb-3"><strong>Participant:</strong><br>${memberName}</div>
                        <div class="col-md-6 mb-3"><strong>Submitted At:</strong><br>${new Date(s.submittedAt).toLocaleString()}</div>
                        
                        <div class="col-12"><hr></div>
                        
                        <h6 class="mb-3 text-primary">Bahagian A: Maklumat Pekerjaan</h6>
                        <div class="col-md-6 mb-2"><strong>Negeri:</strong> ${s.section1.state}</div>
                        <div class="col-md-6 mb-2"><strong>Kategori Jawatan:</strong> ${s.section1.jobPositionCategory}</div>
                        <div class="col-md-6 mb-2"><strong>Tahap Jawatan:</strong> ${s.section1.jobPositionLevel}</div>
                        <div class="col-md-6 mb-2"><strong>Pengalaman (Tahun):</strong> ${s.section1.yearsExperience}</div>
                        <div class="col-md-6 mb-3"><strong>Sektor Majikan:</strong> ${s.section1.employerSector}</div>
                        
                        <div class="col-12"><hr></div>
                        
                        <h6 class="mb-3 text-primary">Bahagian B: Maklumat Kewangan</h6>
                        <div class="col-md-6 mb-2"><strong>Pendapatan Keluarga:</strong> RM ${s.section2.familyIncome}</div>
                        <div class="col-md-6 mb-2"><strong>Julat Hutang:</strong> RM ${s.section2.debtRange}</div>
                        <div class="col-md-6 mb-2"><strong>Julat Simpanan:</strong> RM ${s.section2.savingsRange}</div>
                        <div class="col-md-6 mb-3"><strong>Komitmen Bulanan:</strong> RM ${s.section2.monthlyCommitment}</div>
                        
                        <div class="col-12"><hr></div>
                        
                        <h6 class="mb-3 text-primary">Bahagian C: Maklum Balas & Rujukan</h6>
                        <div class="col-md-6 mb-2"><strong>Guru Kegemaran:</strong> ${s.finalSection.favoriteGuru}</div>
                        <div class="col-md-6 mb-2"><strong>Sumber Rujukan:</strong> ${s.finalSection.referralSource}</div>
                        <div class="col-md-12 mb-3"><strong>Maklum Balas Tambahan:</strong><br>${s.finalSection.feedback || 'Tiada maklum balas disediakan.'}</div>
                        
                        <div class="col-12"><hr></div>
                        
                        <h6 class="mb-3 text-primary">Maklumat Akaun Bank (Tujuan Insentif)</h6>
                        <div class="col-md-6 mb-2"><strong>Nama Bank:</strong> ${s.bankDetails.bankName}</div>
                        <div class="col-md-6 mb-3"><strong>Nombor Akaun:</strong> ${s.bankDetails.accountNumber}</div>
                    </div>
                `;

                $('#surveyModalBody').html(html);
                $('#surveyDetailsModal').modal('show');
            });
        });
    </script>
</body>
</html>
