<!DOCTYPE html>
<html lang="en" data-layout="vertical" data-topbar="light" data-sidebar="dark" data-sidebar-size="lg" data-sidebar-image="none" data-preloader="disable">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Submitted Surveys | Admin Portal</title>

    <script src="assets/js/layout.js"></script>

    <!-- bootstrap css -->
    <link rel="stylesheet" href="assets/css/bootstrap.css">

    <!-- font css -->
	<link rel="stylesheet" href="assets/css/icons.min.css">

    <!-- app css -->
	<link rel="stylesheet" href="assets/css/app.min.css" />

    <!-- custom css -->
	<link rel="stylesheet" href="assets/css/custom.css">

    <link href="assets/images/logos/favicon.ico" rel="shortcut icon" type="image/x-icon" />
</head>
<body>
    <div class="layout-wrapper">
        <!-- page header -->
        <header id="page-topbar"></header>					
        
        <div class="app-menu navbar-menu"></div>
        
        <div class="vertical-overlay"></div>

        <div class="main-content">
            <div class="page-content">
                <div class="container-fluid">
                    <div class="row mb-3 pb-1">
                        <div class="col-12">
                            <div class="d-flex align-items-lg-center flex-lg-row flex-column">
                                <div class="flex-grow-1">
                                    <h4 class="fs-16 mb-1">Submitted Surveys</h4>
                                    <p class="text-muted mb-0">Review responses from YABAM participants.</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-lg-12">
                            <div class="card">
                                <div class="card-body">
                                    <div class="table-responsive table-card">
                                        <table class="table table-borderless table-nowrap align-middle mb-0">
                                            <thead class="table-light text-muted">
                                                <tr>
                                                    <th>Member Name</th>
                                                    <th>Phone Number</th>
                                                    <th>State</th>
                                                    <th>Current Job</th>
                                                    <th>Favorite Guru</th>
                                                    <th>Submitted At</th>
                                                    <th>Status</th>
                                                    <th class="text-center">Action</th>
                                                </tr>
                                            </thead>
                                            <tbody id="surveyTableBody">
                                                <tr>
                                                    <td colspan="8" class="text-center p-5">
                                                        <div class="spinner-border text-primary" role="status">
                                                            <span class="visually-hidden">Loading...</span>
                                                        </div>
                                                        <p class="mt-2 text-muted">Fetching survey data...</p>
                                                    </td>
                                                </tr>
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <footer class="footer">
                <div class="container-fluid">
                    <div class="row">
                        <div class="col-sm-6">
                            Copyright <script>document.write(new Date().getFullYear())</script> Â© CSA Academy - All right reserved.
                        </div>
                    </div>
                </div>
            </footer>
        </div>
    </div>

    <!-- Survey Details Modal -->
    <div class="modal fade" id="surveyDetailsModal" tabindex="-1" aria-labelledby="surveyDetailsModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg modal-dialog-scrollable">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="surveyDetailsModalLabel">Survey Response Details</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body" id="surveyModalBody">
                    <!-- Dynamic Content -->
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="button" class="btn btn-primary" onclick="window.print()">Print Response</button>
                </div>
            </div>
        </div>
    </div>

    <!-- jquery js -->
    <script src="assets/libs/jquery/js/jquery-3.6.3.min.js"></script>
    <!-- bootstrap js -->
    <script src="assets/libs/bootstrap/js/bootstrap.bundle.min.js"></script>
    <script src="assets/libs/simplebar/simplebar.min.js"></script>
    <script src="assets/libs/node-waves/waves.min.js"></script>
    <script src="assets/libs/feather-icons/feather.min.js"></script>
    <!-- App js -->
    <script src="assets/js/app.js"></script>
    <script src="Scripts/navbar.js"></script>
    <script src="Scripts/adminHelper.js"></script>

    <script>
        let allSurveys = [];

        $(document).ready(async function() {
            const surveys = await apiCall('/surveys/admin/all');
            const tbody = $('#surveyTableBody');
            
            if (surveys && surveys.length > 0) {
                allSurveys = surveys;
                tbody.empty();
                surveys.forEach((s, index) => {
                    const memberName = s.member ? `${s.member.firstName} ${s.member.lastName}` : 'N/A';
                    const phoneNumber = s.member ? s.member.phoneNumber : 'N/A';
                    const submittedAt = new Date(s.submittedAt).toLocaleString();
                    
                    tbody.append(`
                        <tr id="survey-${s._id}">
                            <td>${memberName}</td>
                            <td>${phoneNumber}</td>
                            <td>${s.section1.state}</td>
                            <td>${s.section1.jobPositionCategory} - ${s.section1.jobPositionLevel}</td>
                            <td>${s.finalSection.favoriteGuru}</td>
                            <td>${submittedAt}</td>
                            <td><span class="badge bg-success-subtle text-success">${s.status}</span></td>
                            <td class="text-center">
                                <div class="d-flex justify-content-center gap-2">
                                    <button class="btn btn-sm btn-soft-primary view-survey-btn" data-index="${index}">
                                        <i class="ri-eye-line align-bottom"></i> View
                                    </button>
                                    <button class="btn btn-sm btn-soft-danger delete-survey-btn" data-id="${s._id}">
                                        <i class="ri-delete-bin-fill align-bottom"></i> Delete
                                    </button>
                                </div>
                            </td>
                        </tr>
                    `);
                });
            } else {
                tbody.html('<tr><td colspan="8" class="text-center">No surveys found.</td></tr>');
            }

            // Handle Delete
            $(document).on('click', '.delete-survey-btn', async function() {
                const surveyId = $(this).data('id');
                if (confirm('Are you sure you want to delete this survey? This action cannot be undone.')) {
                    try {
                        const result = await apiCall('/surveys/' + surveyId, 'DELETE');
                        if (result && result.msg === 'Survey removed') {
                            $(`#survey-${surveyId}`).fadeOut(function() {
                                $(this).remove();
                                if ($('#surveyTableBody tr').length === 0) {
                                    $('#surveyTableBody').html('<tr><td colspan="8" class="text-center">No surveys found.</td></tr>');
                                }
                            });
                        } else {
                            alert(result.msg || 'Error deleting survey');
                        }
                    } catch (err) {
                        console.error('Delete error:', err);
                        alert('Failed to delete survey. Please try again.');
                    }
                }
            });

            $(document).on('click', '.view-survey-btn', function() {
                const index = $(this).data('index');
                const s = allSurveys[index];
                if (!s) return;

                const memberName = s.member ? `${s.member.firstName} ${s.member.lastName}` : 'N/A';
                
                let html = `
                    <div class="row">
                        <div class="col-md-6 mb-3"><strong>Participant:</strong><br>${memberName}</div>
                        <div class="col-md-6 mb-3"><strong>Submitted At:</strong><br>${new Date(s.submittedAt).toLocaleString()}</div>
                        
                        <div class="col-12"><hr></div>
                        
                        <h6 class="mb-3 text-primary">Bahagian A: Maklumat Pekerjaan</h6>
                        <div class="col-md-6 mb-2"><strong>Negeri:</strong> ${s.section1.state}</div>
                        <div class="col-md-6 mb-2"><strong>Kategori Jawatan:</strong> ${s.section1.jobPositionCategory}</div>
                        <div class="col-md-6 mb-2"><strong>Tahap Jawatan:</strong> ${s.section1.jobPositionLevel}</div>
                        <div class="col-md-6 mb-2"><strong>Pengalaman (Tahun):</strong> ${s.section1.yearsExperience}</div>
                        <div class="col-md-6 mb-3"><strong>Sektor Majikan:</strong> ${s.section1.employerSector}</div>
                        
                        <div class="col-12"><hr></div>
                        
                        <h6 class="mb-3 text-primary">Bahagian B: Maklumat Kewangan</h6>
                        <div class="col-md-6 mb-2"><strong>Pendapatan Keluarga:</strong> RM ${s.section2.familyIncome}</div>
                        <div class="col-md-6 mb-2"><strong>Julat Hutang:</strong> RM ${s.section2.debtRange}</div>
                        <div class="col-md-6 mb-2"><strong>Julat Simpanan:</strong> RM ${s.section2.savingsRange}</div>
                        <div class="col-md-6 mb-3"><strong>Komitmen Bulanan:</strong> RM ${s.section2.monthlyCommitment}</div>
                        
                        <div class="col-12"><hr></div>
                        
                        <h6 class="mb-3 text-primary">Bahagian C: Maklum Balas & Rujukan</h6>
                        <div class="col-md-6 mb-2"><strong>Guru Kegemaran:</strong> ${s.finalSection.favoriteGuru}</div>
                        <div class="col-md-6 mb-2"><strong>Sumber Rujukan:</strong> ${s.finalSection.referralSource}</div>
                        <div class="col-md-12 mb-3"><strong>Maklum Balas Tambahan:</strong><br>${s.finalSection.feedback || 'Tiada maklum balas disediakan.'}</div>
                        
                        <div class="col-12"><hr></div>
                        
                        <h6 class="mb-3 text-primary">Maklumat Akaun Bank (Tujuan Insentif)</h6>
                        <div class="col-md-6 mb-2"><strong>Nama Bank:</strong> ${s.bankDetails.bankName}</div>
                        <div class="col-md-6 mb-3"><strong>Nombor Akaun:</strong> ${s.bankDetails.accountNumber}</div>
                    </div>
                `;

                $('#surveyModalBody').html(html);
                $('#surveyDetailsModal').modal('show');
            });
        });
    </script>
</body>
</html>
