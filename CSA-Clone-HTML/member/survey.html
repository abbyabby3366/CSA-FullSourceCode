<!DOCTYPE html>
<html lang="en" data-layout="vertical" data-topbar="light" data-sidebar="dark" data-sidebar-size="lg" data-sidebar-image="none" data-preloader="disable">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>YABAM Survey | Member Portal</title>

    <script src="../assets/js/layout.js"></script>

    <!-- bootstrap css -->
    <link rel="stylesheet" href="../assets/css/bootstrap.css">

    <!-- font css -->
	<link rel="stylesheet" href="../assets/css/icons.min.css">

    <!-- app css -->
	<link rel="stylesheet" href="../assets/css/app.min.css" />

    <!-- custom css -->
	<link rel="stylesheet" href="../assets/css/custom.css">

    <link rel="stylesheet" href="../assets/libs/select2/css/select2.min.css" />
    <link rel="stylesheet" href="../assets/libs/select2/css/select2-bootstrap-5-theme.min.css" />

    <style>
        .navbar-menu {
            background: #279d69 !important;
        }

        .menu-title {
            color: white !important;
        }

        .navbar-menu .navbar-nav .nav-link {
            color: lightyellow !important;
        }

        .sectiontitle {
            font-weight: 800;
            border-bottom: solid 1px silver;
            font-size: medium;
            width: 100%;
            margin-bottom: 10px;
            padding-top: 5px;
            display: block;
            color: gray;
        }
        
        .btn-tertiary {
            background-color: #279d69;
            color: white;
        }

        .btn-tertiary:hover {
            background-color: #1e7d54;
            color: white;
        }

        #survey-loading {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 400px;
        }

        .loader-survey {
            width: 48px;
            height: 48px;
            border: 5px solid #279d69;
            border-bottom-color: transparent;
            border-radius: 50%;
            display: inline-block;
            box-sizing: border-box;
            animation: rotation 1s linear infinite;
        }

        @keyframes rotation {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>

    <link href="../assets/images/logos/favicon.ico" rel="shortcut icon" type="image/x-icon" />
</head>
<body>
    <div class="layout-wrapper">
        <!-- page header -->
        <header id="page-topbar"></header>					
        
        <div class="app-menu navbar-menu"></div>
        
        <div class="vertical-overlay"></div>

        <div class="main-content">
            <div class="page-content">
                <div class="container-fluid">
                    <!-- page header -->
                    <div class="row mb-3 pb-1">
                        <div class="col-12">
                            <div class="d-flex align-items-lg-center flex-lg-row flex-column">
                                <div class="flex-grow-1">
                                    <h4 class="fs-16 mb-1">PROGRAM LESTARI TINJAUAN</h4>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="row justify-content-center">
                        <div class="col-lg-12">
                            <div class="card">
                                <div class="card-body p-4 text-center" id="survey-loading">
                                    <span class="loader-survey"></span>
                                    <h5 class="mt-4 text-primary">Memuat Turun Maklumat...</h5>
                                    <p class="text-muted">Sila tunggu sebentar sementara kami menyemak status tinjauan anda.</p>
                                </div>

                                <div class="card-body p-4 d-none" id="tab-1">
                                    <div class="text-center mb-4">
                                        <h4>Welcome to YABAM Survey</h4>
                                        <p>Please review and agree to the terms below to participate.</p>
                                    </div>
                                    <div class="mb-3">
                                        <label style="width:100%;"><input type="checkbox" class="term-check" name="terms" /> <span>Saya bersetuju dengan <a href="#" target="_blank">Terma Syarat Program Lestari Tinjauan</a></span></label>
                                        <label style="width:100%;"><input type="checkbox" class="term-check" name="terms-yabam" /> <span>Saya bersetuju dengan <a href="#" target="_blank">Terms of Service (YABAM)</a></span></label>
                                        <label style="width:100%;"><input type="checkbox" class="term-check" name="privacy-policy" /> <span>Saya bersetuju dengan <a href="#" target="_blank">NOTIS PRIVASI YABAM</a></span></label>
                                        <label style="width:100%;"><input type="checkbox" class="term-check" name="cookies-policy" /> <span>Saya bersetuju dengan <a href="#" target="_blank">Cookies Policy</a></span></label>
                                        <hr>
                                        <label style="width:100%;"><input type="checkbox" id="terms-all"/> <span>Saya bersetuju dengan semua syarat disini</span></label>
                                    </div>
                                                                                                
                                    <div class="d-flex justify-content-center mt-4">
                                        <button class="btn btn-tertiary" type="button" id="btnNext1">Sertai</button>
                                    </div>
                                </div>

                                <div class="card-body p-4 d-none" id="tab-2">
                                    <div class="text-center mt-2">
                                        <h5 class="text-primary">Sila isi nama dan nombor telefon anda untuk mendaftar sebagai ahli YABAM dan memulakan tinjauan.</h5>
                                    </div>

                                    <div class="mt-3">
                                        <div class="d-flex flex-column mb-3">
                                            <label class="form-label">Nombor Telefon</label>
                                            <div class="input-group">
                                                <span class="input-group-text">+60</span>
                                                <input type="tel" class="form-control" placeholder="0123456789" />
                                            </div>
                                        </div>
                                        <div class="row">
                                            <div class="col-lg-6 col-sm-12 mb-3">
                                                <label class="form-label">Nama Penuh (seperti IC)</label>
                                                <input type="text" class="form-control" />
                                            </div>
                                            <div class="col-lg-6 col-sm-12 mb-3">
                                                <label class="form-label">Nama Rujukan</label>
                                                <input type="text" class="form-control" />
                                            </div>
                                        </div>
                                    </div>

                                    <div class="d-flex justify-content-end mt-4">
                                        <button class="btn btn-tertiary mx-2" type="button" id="btnNext2">Hantar</button>
                                    </div>
                                </div>

                                <div class="card-body p-4 d-none" id="tab-3">
                                    <div class="text-center mb-4">
                                        <h5 class="text-primary">Questionnaire - Section 1</h5>
                                    </div>

                                    <div class="mb-4">
                                        <label class="form-label">1. Negeri manakah yang anda tinggal sekarang?</label>
                                        <select class="form-select">
                                            <option value="">Sila pilih</option>
                                            <option value="1">Johor</option>
                                            <option value="2">Kedah</option>
                                            <option value="3">Kelantan</option>
                                            <option value="4">Melaka</option>
                                            <option value="5">Negeri Sembilan</option>
                                            <option value="6">Pahang</option>
                                            <option value="7">Perak</option>
                                            <option value="8">Perlis</option>
                                            <option value="9">Pulau Pinang</option>
                                            <option value="10">Sabah</option>
                                            <option value="11">Sarawak</option>
                                            <option value="12">Selangor</option>
                                            <option value="13">Terengganu</option>
                                            <option value="14">W.P. Kuala Lumpur</option>
                                            <option value="15">W.P. Labuan</option>
                                            <option value="16">W.P. Putrajaya</option>
                                        </select>
                                    </div>

                                    <div class="mb-4">
                                        <label class="form-label">2. Apakah jawatan/ posisi anda di tempat kerja?</label>
                                        <div class="row">
                                            <div class="col-md-6 mb-2">
                                                <select class="form-select">
                                                    <option value="">Sila pilih jawapan anda</option>
                                                    <option value="1">Professional</option>
                                                    <option value="2">Management</option>
                                                    <option value="3">Clerical</option>
                                                </select>
                                            </div>
                                            <div class="col-md-6 mb-2">
                                                <select class="form-select">
                                                    <option value="">Sila pilih posisi anda</option>
                                                    <option value="1">Senior</option>
                                                    <option value="2">Junior</option>
                                                </select>
                                            </div>
                                        </div>
                                    </div>

                                    <div class="mb-4">
                                        <label class="form-label">Nama Majikan</label>
                                        <input type="text" class="form-control" />
                                    </div>

                                    <div class="d-flex justify-content-end mt-4">
                                        <button class="btn btn-tertiary" type="button" id="btnBack3">Kembali</button>
                                        <button class="btn btn-tertiary mx-2" type="button" id="btnNext3">Seterusnya</button>
                                    </div>
                                </div>

                                <div class="card-body p-4 d-none" id="tab-4">
                                    <div class="text-center mb-4">
                                        <h5 class="text-primary">Questionnaire - Section 2 (Financial Status)</h5>
                                    </div>

                                    <div class="mb-4">
                                        <label class="form-label">11. Berapakah jumlah pendapatan kasar sekeluarga anda?</label>
                                        <select class="form-select">
                                            <option value="0">Sila pilih jawapan anda</option>
                                            <option value="1">< RM3,000</option>
                                            <option value="2">RM3,001 - RM5,000</option>
                                            <option value="3">RM5,001 - RM10,000</option>
                                            <option value="4">RM10,001 - RM15,000</option>
                                            <option value="5">> RM15,000</option>
                                        </select>
                                    </div>

                                    <div class="mb-4">
                                        <label class="form-label">12. Berapa banyak hutang anda buat masa sekarang? (tidak termasuk hutang rumah)</label>
                                        <select class="form-select">
                                            <option value="0">Sila pilih jawapan anda</option>
                                            <option value="1">< RM100,000</option>
                                            <option value="2">RM100,001 - RM200,000</option>
                                            <option value="3">> RM200,000</option>
                                        </select>
                                    </div>

                                    <div class="d-flex justify-content-end mt-4">
                                        <button class="btn btn-tertiary" type="button" id="btnBack4">Kembali</button>
                                        <button class="btn btn-tertiary mx-2" type="button" id="btnNext4">Seterusnya</button>
                                    </div>
                                </div>

                                <div class="card-body p-4 d-none" id="tab-5">
                                    <div class="text-center mb-4">
                                        <h5 class="text-primary">Final Section</h5>
                                    </div>
                                    <div class="mb-4">
                                        <label class="form-label">21. Siapakah guru kewangan yang paling anda minati?</label>
                                        <select class="form-select">
                                            <option value="0">Sila pilih jawapan anda</option>
                                            <option value="1">Tiada</option>
                                            <option value="2">Financial Faiz</option>
                                            <option value="3">Dr Adam Zubir</option>
                                        </select>
                                    </div>

                                    <div class="d-flex justify-content-end mt-4">
                                        <button class="btn btn-tertiary" type="button" id="btnBack5">Kembali</button>
                                        <button class="btn btn-tertiary mx-2" type="button" id="btnNext5">Hantar Tinjauan Saya</button>
                                    </div>
                                </div>

                                <div class="card-body p-4 d-none" id="tab-6">
                                    <div class="text-center mb-4">
                                        <h5 class="text-primary">Bank Account Details</h5>
                                        <p>For reward distribution purposes (RM200 reward).</p>
                                    </div>

                                    <div class="mb-3">
                                        <label class="form-label">Nama Bank</label>
                                        <select class="form-select">
                                            <option value="">Pilih Bank</option>
                                            <option value="1">Maybank</option>
                                            <option value="2">CIMB Bank</option>
                                            <option value="3">Public Bank</option>
                                            <option value="4">RHB Bank</option>
                                        </select>
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label">Nombor Akaun Bank</label>
                                        <input type="text" class="form-control" />
                                    </div>

                                    <div class="d-flex justify-content-end mt-4">
                                        <button class="btn btn-tertiary mx-2" type="button" id="btnNext6">Hantar</button>
                                    </div>
                                </div>

                                <div class="card-body p-4 d-none" id="tab-7">
                                    <div class="text-center mb-4">
                                        <h4 class="text-success">Thank You!</h4>
                                        <p>Your survey has been submitted successfully. You will receive the reward after verification.</p>
                                    </div>
                                    <center>
                                        <a href="dashboard.html" class="btn btn-tertiary">Back to Dashboard</a>
                                    </center>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <footer class="footer">
                <div class="container-fluid">
                    <div class="row">
                        <div class="col-sm-6">
                            © Hak Cipta <script>document.write(new Date().getFullYear())</script> © YAYASAN AMANAH BANTUAN AWAM MALAYSIA - Hak cipta terpelihara.
                        </div>
                        <div class="col-sm-6">
                            <div class="text-sm-end d-none d-sm-block">
                                Design & Develop by Epic Unicorn
                            </div>
                        </div>
                    </div>
                </div>
            </footer>
        </div>
    </div>

    <!-- jquery js -->
    <script src="../assets/libs/jquery/js/jquery-3.6.3.min.js"></script>

    <!-- bootstrap js -->
    <script src="../assets/libs/bootstrap/js/bootstrap.bundle.min.js"></script>

    <!-- utils js -->
    <script src="../assets/libs/simplebar/simplebar.min.js"></script>
    <script src="../assets/libs/node-waves/waves.min.js"></script>

    <!-- font js -->
    <script src="../assets/libs/feather-icons/feather.min.js"></script>
    <script src="../assets/js/pages/plugins/lord-icon-2.1.0.js"></script>

    <script src="../assets/libs/select2/js/select2.min.js"></script>

    <!-- App js -->
    <script src="../assets/js/app.js"></script>
    <script src="navbar-member.js"></script>

    <script>
        $(document).ready(async function() {
            const token = localStorage.getItem('token');
            if (!token) {
                window.location.href = 'index.html';
                return;
            }

            // Check if survey already completed
            try {
                const response = await fetch('http://localhost:5000/api/surveys/me', {
                    headers: { 'x-auth-token': token }
                });
                const survey = await response.json();
                
                $('#survey-loading').addClass('d-none');
                
                if (survey) {
                    let alertClass = 'alert-info';
                    let statusLabel = survey.status;
                    
                    if (survey.status === 'Pending') alertClass = 'alert-warning';
                    else if (survey.status === 'Approved') alertClass = 'alert-success';
                    else if (survey.status === 'Rejected') alertClass = 'alert-danger';

                    $('#tab-1').removeClass('d-none').html(`
                        <div class="text-center mb-4">
                            <h4 class="text-primary">Tinjauan Anda / Your Survey</h4>
                            <p>Terima kasih kerana meluangkan masa untuk menjawab tinjauan kami.</p>
                            <div class="alert ${alertClass} fw-bold">Status: ${statusLabel}</div>
                        </div>
                        <div class="d-flex justify-content-center mt-4">
                            <a href="dashboard.html" class="btn btn-tertiary mx-2">Dashboard</a>
                            <button class="btn btn-outline-primary mx-2" onclick="window.location.href='survey-details.html'">View History</button>
                        </div>
                    `);
                } else {
                    $('#tab-1').removeClass('d-none');
                }
            } catch (err) {
                console.error('Error checking survey status:', err);
                $('#survey-loading').addClass('d-none');
                $('#tab-1').removeClass('d-none');
            }

            function goTab(from, to) {
                $('#tab-' + from).addClass('d-none');
                $('#tab-' + to).removeClass('d-none');
            }

            $('#btnNext1').click(function() {
                if ($('.term-check:checked').length < 4) {
                    alert('Sila bersetuju dengan semua terma dan syarat.');
                    return;
                }
                goTab(1, 2);
            });

            $('#btnNext2').click(function() { goTab(2, 3); });
            $('#btnNext3').click(function() { goTab(3, 4); });
            $('#btnBack3').click(function() { goTab(3, 2); });
            $('#btnNext4').click(function() { goTab(4, 5); });
            $('#btnBack4').click(function() { goTab(4, 3); });
            $('#btnNext5').click(function() { goTab(5, 6); });
            $('#btnBack5').click(function() { goTab(5, 4); });
            
            $('#btnNext6').click(async function() { 
                // Collect survey data
                const surveyData = {
                    section1: {
                        state: $('#tab-3 select').eq(0).val(),
                        jobPositionCategory: $('#tab-3 select').eq(1).val(),
                        jobPositionLevel: $('#tab-3 select').eq(2).val(),
                        employerName: $('#tab-3 input').val()
                    },
                    section2: {
                        familyIncome: $('#tab-4 select').eq(0).val(),
                        debtRange: $('#tab-4 select').eq(1).val()
                    },
                    finalSection: {
                        favoriteGuru: $('#tab-5 select').val()
                    },
                    bankDetails: {
                        bankName: $('#tab-6 select').val(),
                        bankAccountNumber: $('#tab-6 input').val()
                    }
                };

                try {
                    const response = await fetch('http://localhost:5000/api/surveys/submit', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'x-auth-token': token
                        },
                        body: JSON.stringify(surveyData)
                    });

                    if (response.ok) {
                        goTab(6, 7);
                    } else {
                        const err = await response.json();
                        alert('Error: ' + err.msg);
                    }
                } catch (err) {
                    console.error('Submission error:', err);
                    alert('An error occurred during submission.');
                }
            });

            $('#terms-all').change(function() {
                $('.term-check').prop('checked', $(this).prop('checked'));
            });

            $('.term-check').change(function() {
                if ($('.term-check:checked').length == 4) {
                    $('#terms-all').prop('checked', true);
                } else {
                    $('#terms-all').prop('checked', false);
                }
            });
        });
    </script>
</body>
</html>
