<!DOCTYPE html>
<html lang="en" data-layout="vertical" data-topbar="light" data-sidebar="dark" data-sidebar-size="lg" data-sidebar-image="none" data-preloader="disable">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Ganjaran | Member Portal</title>

    <script src="../assets/js/layout.js"></script>

    <!-- bootstrap css -->
    <link rel="stylesheet" href="../assets/css/bootstrap.css">

    <!-- font css -->
	<link rel="stylesheet" href="../assets/css/icons.min.css">

    <!-- app css -->
	<link rel="stylesheet" href="../assets/css/app.min.css" />

    <!-- custom css -->
	<link rel="stylesheet" href="../assets/css/custom.css">

    <!-- datatables css -->
    <link href="../assets/libs/datatables/datatables.min.css" rel="stylesheet" type="text/css" />

    <style>
        .navbar-menu {
            background: #279d69 !important;
        }

        .menu-title {
            color: white !important;
        }

        .navbar-menu .navbar-nav .nav-link {
            color: lightyellow !important;
        }

        span.circle_icon {
            background: #efefef;
            border-radius: 50%;
            display: inline-block;
            padding: 0.65rem;
            text-align: center;
            vertical-align: middle;
            line-height: 0.95rem;
            width: 38px;
            height: 38px;
        }

        .dt-length label {
            margin-left: 8px !important;
        }

        .dt-search input {
            margin-left: 8px !important;
        }
    </style>

    <link href="../assets/images/logos/favicon.ico" rel="shortcut icon" type="image/x-icon" />
</head>
<body>
    <div class="layout-wrapper">
        <!-- page header -->
        <header id="page-topbar"></header>					
        
        <div class="app-menu navbar-menu"></div>
        
        <div class="vertical-overlay"></div>

        <div class="main-content">
            <div class="page-content">
                <div class="container-fluid">
                    <!-- page header -->
                    <div class="row mb-3 pb-1">
                        <div class="col-12">
                            <div class="d-flex align-items-lg-center flex-lg-row flex-column">
                                <div class="flex-grow-1">
                                    <h4 class="fs-16 mb-1">Ganjaran</h4>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-lg-4">
                            <div class="card card-animate">
                                <div class="card-body">
                                    <div class="d-flex align-items-center">
                                        <div class="flex-shrink-0">
                                            <span class="circle_icon"><i class="ri-wallet-line text-primary fs-20"></i></span>
                                        </div>
                                        <div class="flex-grow-1 ms-3">
                                            <h6 class="fs-14 mb-1">Total Rewards</h6>
                                            <p class="text-muted mb-0">Balance Available</p>
                                        </div>
                                        <div class="flex-shrink-0 text-end">
                                            <h3 class="fs-22 fw-bold m-0 text-primary" id="totalRewards">RM 0.00</h3>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="col-lg-8">
                            <div class="card">
                                <div class="card-header align-items-center d-flex">
                                    <h5 class="card-title mb-0 flex-grow-1"><i class="ri-pages-line"></i> Transaction History</h5>
                                </div>
                                <div class="card-body">
                                    <div class="table-responsive table-card m-0 p-0">
                                        <table class="table table-borderless table-nowrap align-middle mb-0" id="historyTable" style="width: 100%;">
                                            <thead class="table-light text-muted">
                                                <tr>
                                                    <th scope="col">TRANSACTION ID</th>
                                                    <th scope="col">DATE</th>
                                                    <th scope="col">TYPE</th>
                                                    <th scope="col">DESCRIPTION</th>
                                                    <th scope="col">AMOUNT</th>
                                                </tr>
                                            </thead>
                                            <tbody id="transactionBody">
                                                <!-- Dynamic Content -->
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <footer class="footer">
                <div class="container-fluid">
                    <div class="row">
                        <div class="col-sm-6">
                            © Hak Cipta <script>document.write(new Date().getFullYear())</script> © YAYASAN AMANAH BANTUAN AWAM MALAYSIA - Hak cipta terpelihara.
                        </div>
                        <div class="col-sm-6">
                            <div class="text-sm-end d-none d-sm-block">
                                Design & Develop by Epic Unicorn
                            </div>
                        </div>
                    </div>
                </div>
            </footer>
        </div>
    </div>

    <!-- jquery js -->
    <script src="../assets/libs/jquery/js/jquery-3.6.3.min.js"></script>

    <!-- bootstrap js -->
    <script src="../assets/libs/bootstrap/js/bootstrap.bundle.min.js"></script>

    <!-- utils js -->
    <script src="../assets/libs/simplebar/simplebar.min.js"></script>
    <script src="../assets/libs/node-waves/waves.min.js"></script>

    <!-- font js -->
    <script src="../assets/libs/feather-icons/feather.min.js"></script>
    <script src="../assets/js/pages/plugins/lord-icon-2.1.0.js"></script>

    <!-- datatables js -->
    <script src="../assets/libs/datatables/datatables.min.js"></script>

    <!-- App js -->
    <script src="../assets/js/app.js"></script>
    <script src="memberHelper.js"></script>
    <script src="navbar-member.js"></script>

    <script>
        $(document).ready(async function() {
            const member = await initMemberPortal();
            if (member) {
                // Update Balance
                $('#totalRewards').text('RM ' + member.walletCash.toLocaleString(undefined, { minimumFractionDigits: 2 }));

                // Fetch Transactions
                loadTransactions();
            }
        });

        async function loadTransactions() {
            const token = localStorage.getItem('token');
            try {
                const response = await fetch('http://localhost:5000/api/members/transactions', {
                    headers: {
                        'x-auth-token': token
                    }
                });
                const transactions = await response.json();

                const tbody = $('#transactionBody');
                tbody.empty();

                transactions.forEach(trx => {
                    const date = new Date(trx.createDate).toLocaleString();
                    const amountClass = trx.amount >= 0 ? 'text-success' : 'text-danger';
                    const amountPrefix = trx.amount >= 0 ? '+ ' : '- ';
                    const absAmount = Math.abs(trx.amount).toFixed(2);
                    
                    let typeBadge = '';
                    switch(trx.type) {
                        case 'Reward': typeBadge = '<span class="badge bg-soft-success text-success">Reward</span>'; break;
                        case 'Referral': typeBadge = '<span class="badge bg-soft-info text-info">Referral</span>'; break;
                        case 'Withdrawal': typeBadge = '<span class="badge bg-soft-danger text-danger">Withdrawal</span>'; break;
                        case 'Bonus': typeBadge = '<span class="badge bg-soft-primary text-primary">Bonus</span>'; break;
                        default: typeBadge = `<span class="badge bg-soft-secondary text-secondary">${trx.type}</span>`;
                    }

                    const row = `
                        <tr>
                            <td>#${trx._id.substring(trx._id.length - 6).toUpperCase()}</td>
                            <td>${date}</td>
                            <td>${typeBadge}</td>
                            <td>${trx.description || '-'}</td>
                            <td class="text-end ${amountClass}">${amountPrefix}${absAmount}</td>
                        </tr>
                    `;
                    tbody.append(row);
                });

                $('#historyTable').DataTable({
                    order: [[1, 'desc']],
                    destroy: true,
                    autoWidth: false
                });

            } catch (err) {
                console.error('Error loading transactions:', err);
            }
        }
    </script>
</body>
</html>
